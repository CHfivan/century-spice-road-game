<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rest Action Final Round Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 10px 15px; margin: 5px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; max-height: 400px; overflow-y: auto; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Rest Action Final Round Test</h1>
    
    <div class="test-section">
        <h2>Test Scenario</h2>
        <p><strong>2-Player Game:</strong> Player 1 triggers final round, then Player 2 chooses to Rest (should end the game).</p>
        <button onclick="runRestTest()">Run Rest Final Round Test</button>
        <div id="test-log" class="log"></div>
    </div>

    <script src="js/cards.js"></script>
    <script src="js/game.js"></script>
    <script>
        function log(message, type = 'normal') {
            const logDiv = document.getElementById('test-log');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            logDiv.innerHTML += `<span class="${className}">${message}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function runRestTest() {
            document.getElementById('test-log').innerHTML = '';
            
            log('=== REST ACTION FINAL ROUND TEST ===');
            
            // Create a 2-player game
            const game = new Game();
            game.setupGame(2);
            
            log(`Game started with ${game.players.length} players`);
            log(`Victory cards needed: ${game.victoryCardsNeeded}`);
            log(`Starting player: Player 1 (index ${game.currentPlayerIndex})`);
            log('');
            
            // Player 1 triggers final round
            const player1 = game.players[0];
            const player2 = game.players[1];
            
            // Give Player 1 enough victory cards to trigger final round
            for (let i = 0; i < game.victoryCardsNeeded; i++) {
                player1.victoryCards.push({
                    id: `test-victory-${i}`,
                    points: 10,
                    cost: { yellow: 1 }
                });
            }
            
            // Trigger final round
            game.finalRoundTriggered = true;
            game.finalRoundTriggerPlayer = player1;
            log(`✓ Final round triggered by Player 1`);
            log(`Player 1 has ${player1.victoryCards.length} victory cards`);
            log('');
            
            // Move to Player 2's turn
            game.nextTurn();
            log(`Current player: ${game.getCurrentPlayer().name} (Player 2)`);
            log(`Game ended after moving to Player 2: ${game.gameEnded}`);
            
            // Give Player 2 some cards in discard pile so they can rest
            player2.discardPile.push({
                id: 'test-card-1',
                name: 'Test Card 1',
                type: 'gain',
                effect: { yellow: 1 }
            });
            player2.discardPile.push({
                id: 'test-card-2',
                name: 'Test Card 2',
                type: 'gain',
                effect: { yellow: 2 }
            });
            
            log(`Player 2 has ${player2.discardPile.length} cards in discard pile`);
            log(`Player 2 has ${player2.hand.length} cards in hand`);
            log('');
            
            // Player 2 chooses to Rest
            log('Player 2 chooses to Rest...');
            const restResult = game.rest(player2);
            
            if (restResult.success) {
                log(`✓ Rest action successful: ${restResult.message}`);
                log(`Player 2 now has ${player2.hand.length} cards in hand`);
                log(`Player 2 now has ${player2.discardPile.length} cards in discard pile`);
                log('');
                
                // Now simulate the turn ending (this should trigger game end)
                log('Ending Player 2\'s turn...');
                const gameEndedBefore = game.gameEnded;
                game.nextTurn();
                const gameEndedAfter = game.gameEnded;
                
                log(`Game ended before nextTurn(): ${gameEndedBefore}`);
                log(`Game ended after nextTurn(): ${gameEndedAfter}`);
                
                if (gameEndedAfter) {
                    log(`✓ SUCCESS: Game ended after Player 2's Rest action!`, 'success');
                    log(`✓ Winner: ${game.winner.name}`, 'success');
                    log(`✓ Rest action correctly triggered game end in final round!`, 'success');
                } else {
                    log(`✗ ERROR: Game should have ended after Player 2's Rest action`, 'error');
                    log(`Current player would be: ${game.getCurrentPlayer().name}`, 'error');
                }
            } else {
                log(`✗ Rest action failed: ${restResult.message}`, 'error');
            }
            
            log('');
            log('=== TEST COMPLETE ===');
        }
    </script>
</body>
</html>