<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Final Round Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 10px 15px; margin: 5px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; font-family: monospace; max-height: 400px; overflow-y: auto; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Comprehensive Final Round Test</h1>
    
    <div class="test-section">
        <h2>Test All Player Counts with Rest Actions</h2>
        <p>Tests that the final round ends correctly when players use Rest actions instead of other actions.</p>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearLog()">Clear Log</button>
        <div id="test-log" class="log"></div>
    </div>

    <script src="js/cards.js"></script>
    <script src="js/game.js"></script>
    <script>
        function log(message, type = 'normal') {
            const logDiv = document.getElementById('test-log');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : '';
            logDiv.innerHTML += `<span class="${className}">${message}</span><br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        function testPlayerCount(playerCount) {
            log(`\n=== TESTING ${playerCount} PLAYERS ===`);
            
            const game = new Game();
            game.setupGame(playerCount);
            
            log(`Victory cards needed: ${game.victoryCardsNeeded}`);
            log(`Starting player: ${game.getCurrentPlayer().name} (index ${game.currentPlayerIndex})`);
            
            // Player 1 triggers final round
            const player1 = game.players[0];
            for (let i = 0; i < game.victoryCardsNeeded; i++) {
                player1.victoryCards.push({
                    id: `test-victory-${i}`,
                    points: 10,
                    cost: { yellow: 1 }
                });
            }
            
            // Trigger final round
            game.finalRoundTriggered = true;
            game.finalRoundTriggerPlayer = player1;
            log(`Final round triggered by Player 1`);
            
            // Give all other players cards in discard pile so they can rest
            for (let i = 1; i < playerCount; i++) {
                const player = game.players[i];
                player.discardPile.push({
                    id: `test-card-${i}`,
                    name: `Test Card ${i}`,
                    type: 'gain',
                    effect: { yellow: 1 }
                });
            }
            
            // Simulate each remaining player getting their final turn (using Rest action)
            let turnsAfterTrigger = 0;
            const maxTurns = playerCount * 2; // Safety limit
            
            while (!game.gameEnded && turnsAfterTrigger < maxTurns) {
                const currentPlayerBefore = game.getCurrentPlayer();
                log(`Turn ${turnsAfterTrigger + 1}: ${currentPlayerBefore.name} (index ${game.currentPlayerIndex}) - Rest action`);
                
                // Simulate Rest action
                if (currentPlayerBefore.discardPile.length > 0) {
                    const restResult = game.rest(currentPlayerBefore);
                    log(`  Rest result: ${restResult.success ? 'Success' : 'Failed'}`);
                }
                
                game.nextTurn();
                turnsAfterTrigger++;
                
                if (game.gameEnded) {
                    log(`Game ended after ${turnsAfterTrigger} turns`, 'success');
                    break;
                }
            }
            
            // Verify correct behavior
            const expectedTurns = playerCount - 1; // Everyone except trigger player gets one turn
            if (turnsAfterTrigger === expectedTurns && game.gameEnded) {
                log(`✓ CORRECT: Game ended after exactly ${expectedTurns} turns (with Rest actions)`, 'success');
                log(`✓ Winner: ${game.winner.name}`, 'success');
            } else if (turnsAfterTrigger !== expectedTurns) {
                log(`✗ ERROR: Expected ${expectedTurns} turns, got ${turnsAfterTrigger}`, 'error');
            } else if (!game.gameEnded) {
                log(`✗ ERROR: Game should have ended but didn't`, 'error');
            }
            
            return turnsAfterTrigger === expectedTurns && game.gameEnded;
        }

        function runAllTests() {
            clearLog();
            log('Starting comprehensive final round tests...\n');
            
            let allPassed = true;
            
            for (let playerCount = 2; playerCount <= 5; playerCount++) {
                const passed = testPlayerCount(playerCount);
                if (!passed) {
                    allPassed = false;
                }
            }
            
            log('\n=== SUMMARY ===');
            if (allPassed) {
                log('✓ ALL TESTS PASSED! Final round logic is working correctly.', 'success');
            } else {
                log('✗ SOME TESTS FAILED! Check the logic above.', 'error');
            }
        }
    </script>
</body>
</html>